# 《电子系统专题设计与制作》大作业 实验报告
**完成的任务：**

任务一 （共10分）

- 1.1 总体设计 20空，共5分
- 1.2 单元验证
  - Ex1.2.1 1分
  - Ex1.2.2 1分
  - Ex1.2.3 1分
  - Ex1.2.4 1分
  - Ex1.2.5 1分

任务二（共10分）

- Ex2.1 0.5分
- Ex2.2 1分
- Ex2.3 1分
- Ex2.4 1分
- Ex2.5 1分
- Ex2.6 2分
- Ex2.7 1分
- Ex2.8 1分
- Ex2.9 1分
- Ex2.10 0.5分

任务三（最高计7分，完成9分）

- Ex3.1 3分
- Ex3.3 2分
- Ex3.4 2分
- Ex3.5 1分
- Ex3.6 1分

## 任务一 · 基础设计与单元验证（10 分）

### 1.1 总体设计（5 分）

1. `LED`  
2. `PWM波控制` 
3. `OLED`
4. `3.3`  
5. `I²C 协议通讯`  
6. `5`  
7. `舵机`  
8. `PWM波控制`  
9. `蜂鸣器`  
10. `数字信号直接控制`  
11. `模拟`  
12. `GND`  
13. `5`  
14. `超声波测距`  
15. `上拉`  
16. `数字输入`  
17. `电机驱动`  
18. `PWM波`  
19. `编码器`  
20. `12`

### 1.2 单元验证（5 分）

- **Ex1.2.1**  测试 LED 控制：使用 UNO 驱动三色 LED 实现「此起彼伏」呼吸灯

循环调控三种颜色亮与不亮，呼吸灯以`step`为步长，到达边界后方向反转。

- **Ex1.2.2**  通过按键实现开关机。长按，开机并进入上述呼吸灯模式；长按，进入待机模式。

用`onebutton`库关联按钮，用`switchPower`切换亮灭。

- **Ex1.2.3**  测试显示模块与按钮：通过两个按钮实现一个值的增减（如，按一个增，按一个减），将该值在屏幕显示

两个函数，一个增加值一个减少值。

- **Ex1.2.4**  测试滚轮输入与指针：电机旋转→编码器读取角度→指针显示

设置舵机初始位置为0，将电机角度映射为舵机角度实现方法如下：

编码器每转一圈输出 360 个脉冲，使舵机转动 30 度，舵机角度与编码器脉冲数的关系为：
$$
\theta_{\text{servo}} = \frac{\theta_{\text{motor}}}{12}
$$

- **Ex1.2.5**  进度条显示滚轮旋转角度

Encoder会把AB信号电平变化都计数，一圈为360*4=1440。

## 任务二 · 任务三 功能部分

**接线示意图**——用 Wokwi 截图  

![image-20250814001208615](C:\Users\sang\AppData\Roaming\Typora\typora-user-images\image-20250814001208615.png)

**总体**：设置七个`state`分别对应七个主要的功能单元。由于相同按钮操作在不同事件中意义不同，故在按下按钮之后先对当前任务判断，再执行相应功能。

**按钮模块**：

**按钮 1（BTN1）**

- **单击**：
  - 如果当前在 *手电筒模式* → 切换亮度挡位（`ledLvl++`）。
- **长按**：
  - 如果当前在 *开机动画模式* → 进入菜单界面。
- **双击**：
  - 如果当前在 *菜单界面* → 进入当前高亮的功能页，并进行对应初始化：
    - 音乐播放器 → 重置播放状态
    - 示波器 → 初始化波形缓存、通道索引、关闭灯光
    - 其他模式 → 静音并重置音乐状态
  - 如果当前在 *功能页*（Flashlight、Voltage Meter、Rangefinder、Oscilloscope、Music Player） → 返回菜单，并静音、重置音乐状态。

**按钮 2（BTN2）**

- **单击**：
  - 如果当前在 *音乐播放器模式* → 播放/暂停切换：
    - 暂停时 → 停止蜂鸣器、关灯、亮蓝灯、记录暂停时间
    - 恢复时 → 补偿暂停时间以保持进度条连续、准备下一音符播放、关灯
  - 如果当前在 *示波器模式* → 切换到下一个通道，并清空波形缓存、重置采样时间。
- **长按**：
  - 如果当前在 *测距模式* → 切换阈值设置模式（进入/退出）。
  - 如果当前在 *音乐播放器模式* → 切换到下一首歌，并复位播放状态（停止蜂鸣器、关灯、复位索引和时间等）。

**菜单模块**：

- **Ex2.1**  上电时 OLED 显示欢迎语

- **Ex2.2**  简易菜单：长按按钮 1 进入菜单，电机旋转上下翻动，双击选定；进入界面后顶部显示功能名
- **Ex3.1**  实现 3D 菜单界面
- **Ex3.5**  开机时显示小动画

为了便于修改和使主程序更清晰易读，用`Bitmaps.h`存储位图数据。

开机上方显示welcome语句，下方显示小火车进入动画。小火车每次右移动3，到最右侧后回到左侧重新播放，不断循环。

`fAnim`为当前动画帧号 `0..149`，用于从轨迹表 `menu_positions` 中取位置。`prev`记录上一轮的 `encCnt`，计算本轮与上轮的差值 `diff``selMenu`与 `fAnim` 结合确定每个菜单项的“展示顺序”）。顺时针转舵机则推进一帧，逆时针转舵机则回退一帧。

`f` 决定了该菜单项此刻的位置（x,y）以及是否处于“高亮区”。将 0..15 与 135..149 设为“高亮区”，中间过渡使用不同的 `sfrm`，实现缩放效果。位图按“每个菜单 11 帧（0..10）”集中存放：
 `((selMenu + i) % NUM_MENU_ITEMS)` 选择第几个菜单项，`*11 + sfrm` 选择该菜单项的第几帧，可以在同一个动画时间点，让 5 个图标各处于不同的位置与缩放帧，构成“转盘”感。

**手电筒模块**：

- **Ex2.3**  手电筒：按钮循环切换「微亮蓝 → 微亮白 → 最亮白」，双击或返回菜单关闭（RGB 全亮为白，可参考作业 3）

调节RGB不同PWM值实现微微蓝色，白色微亮和白色最亮。

**电压表模块**：

- **Ex2.4**  电压表：屏幕数值显示（V，保留两位小数）＋ 舵机指针（10–170° 对应 0–5 V，可自制纸表盘）
- **Ex3.6**  电压表模式下同时显示一个指针

实现时遇到了识别不到双击操作的问题，解决方案是在功能循环里加 `if (now - lastDraw < 50) return;` 限制刷新频率，从而让按键检测（尤其是双击）有足够的时间被及时采样和识别。

绘制指针时，先把角度换算成弧度，再通过极坐标变换计算指针末端坐标，并用 `drawLine` 从表盘中心连到该坐标。

**测距模块**：

- **Ex2.5**  测距仪：屏幕显示距离（cm，保留两位有效数字）
- **Ex2.6**  测距报警：阈值默认 15 cm；长按按钮 2 进入阈值调节（蓝灯呼吸），电机调节 10–50 cm；测距模式下距离＜阈值则红灯闪烁＋蜂鸣器嘀嘀嘀，频率随距离减小而升高，否则绿灯常亮，蜂鸣器静音

报警：当 `on==true`（亮响状态）时，持续时间固定为 `half`，且最大不超过 50ms；当 `on==false`（静默状态）时，持续时间是 `cycle - half`，这个时间会随距离变化而变长或变短，从而让整体周期随距离动态调整。用 `now - last` 判断当前状态是否达到设定时长，若到达则翻转 `on` 并更新时间，实现按不同间隔交替的亮响与静默节拍。

两位有效数字：若 `d >= 10`，四舍五入到整数；若 `1 <= d < 10`，四舍五入到一位小数；若 `0.10 <= d < 1`，四舍五入到两位小数（如 0.256→“0.26”）。更小则显示“<0.10”。具体用 `floorf(d+0.5)`、`roundf(d*10)/10`、`roundf(d*100)/100` 得到数值，再用 `dtostrf(..., 精度)` 转成字符串。

**示波器功能**：

- **Ex2.7**  示波器：屏幕显示两根垂直坐标轴（示意图）
- **Ex2.8**  示波器：绘制模拟输入 A0 的时域波形（可用电位器测试）
- **Ex2.9**  示波器：单击按钮 2 依次切换通道 A0→A1→A2→…→A0，并在 OLED 显示当前通道

将 `millis()` 与 `lastSamp` 比较，间隔大于设定的采样周期 `SMP_INT_MS` 时采样，可以控制波形刷新速度。采样前先将 `waveBuf` 中的数据整体左移一位，相当于把旧波形向左滚动，为新的采样腾位置。随后用 `analogRead()` 读取当前通道 `ainPins[chIdx]` 的电压值，并通过 `map()` 将其从 `[0,1023]` 转换到屏幕像素坐标范围 `[OSC_H-1,0]`，存入波形缓存的最后一位。遍历缓存 `waveBuf` 的每个相邻点 `(xA,yA)` 和 `(xB,yB)`，用 `drawLine()` 连接起来，形成连续的波形轨迹。

**音乐播放模块**：

- **Ex2.10**  音乐播放器：Arduino 预存一段音乐（原创或作业 5《东方红》均可），按按钮 2 播放
- **Ex3.3**  音乐播放器：播放进度条＋节奏闪灯，播放中按钮 2 暂停
- **Ex3.4**  音乐播放器：曲库功能，长按按钮 2 切歌并显示曲目名

曲库 `songs` 是“指向二维整型数组的指针数组”，每首歌都是一串 `{频率Hz, 时长ms}` 的音符对，最后用 `{0, 0}` 作为终止标记。播放时通过 `noteIdx` 逐个取出音符对：`f = curSong[noteIdx][0]`、`d = curSong[noteIdx][1]`，若遇到 `{0,0}` 则认为该曲目结束并复位索引。总时长 `songDur[s]` 在 `setup()` 里把该首歌所有 `d` 累加得到，用于进度条。

开始播放时记录 `songBeg = millis()`，暂停时记下 `pausAt`，显示时根据状态计算已用时 `elp = isPause ? (pausAt - songBeg) : (millis() - songBeg)`，并用 `map(elp, 0, tot, 0, bw)` 将其映射为条形宽度 `pw`，`u8g2.drawBox()` 画进度条。

每发声音符（`f > 0`）时调用 `tone(BUZZ, f)` 同时点亮绿灯 `analogWrite(G_PIN, 255)`，置 `ledBeatOn = true` 并设定 `ledOffAt = millis() + 100`；在循环开头检测 `if (ledBeatOn && millis() >= ledOffAt)`，到点就 `turnAllLedsOff()` 并清标志，实现“每个音符起始短促闪亮”的节拍效果；若是休止（`f <= 0`）则 `noTone()` 并熄灯。音符切换由 `noteEndAt = millis() + d` 控制，到时递增 `noteIdx` 播放下一拍。
